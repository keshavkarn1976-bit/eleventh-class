<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Price Elasticity of Demand Chapter Quiz</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'cbse-blue': '#1a3e6a', 
                        'cbse-light': '#f0f4f8', 
                        'accent-green': '#059669', 
                        'correct': '#10b981', /* Emerald 500 */
                        'incorrect': '#ef4444', /* Red 500 */
                    }
                }
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script> 

    <script src="/eleventh-class/js/config.js"></script> 
</head>
<body class="bg-cbse-light min-h-screen antialiased">

    <header class="bg-white shadow-lg sticky top-0 z-10 border-t-8 border-cbse-blue">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <h1 class="text-2xl font-bold text-cbse-blue">Price Elasticity of Demand Quiz Portal</h1>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <div id="quiz-container" class="container bg-white p-4 md:p-6 rounded-xl shadow-lg"> 
            <p class="text-cbse-blue font-semibold">Loading quiz modules...</p>
        </div>

        <div id="config-error" class="hidden error-message mt-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative">
            Configuration Error ðŸ›‘<br>Quiz failed to load because Supabase credentials are missing or the 'config.js' file could not be found.
        </div>
    </main>
    
    <script>
        // ==================================================================================
        // FIREBASE INITIALIZATION AND LOGGING FUNCTION
        // (Must be defined outside of submitQuiz but inside the main script block)
        // ==================================================================================

        // YOUR FIREBASE CONFIGURATION (Must be the same as economics.html)
        const firebaseConfig = {
            apiKey: "AIzaSyAXdKiYRxBKAj280YcNuNwlKKDp85xpOWQ",
            authDomain: "quiz-signon.firebaseapp.com",
            projectId: "quiz-signon",
            storageBucket: "quiz-signon.firebasestorage.app",
            messagingSenderId: "863414222321",
            appId: "1:863414222321:web:819f5564825308bcd9d850",
            measurementId: "G-4EFDM0CRYY"
        };

        // Initialize Firebase App, Auth, and Firestore
        const app = firebase.initializeApp(firebaseConfig);
        const auth = app.auth(); 
        const db = app.firestore(); 

        /**
         * Logs the final score and details to the 'quiz_scores' collection in Firestore.
         */
        function logFinalQuizScore(score, total, chapterName, difficulty) {
            const user = auth.currentUser;

            if (!user) {
                console.warn("User not logged in. Score not saved.");
                return;
            }

            db.collection("quiz_scores").add({ 
                userId: user.uid,
                email: user.email || 'N/A',
                chapter: chapterName,          
                difficulty: difficulty,        
                score: score,                  
                total: total,              
                percentage: (score / total) * 100,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                action: 'Quiz Completed'
            })
            .then(() => {
                console.log(`Final score ${score}/${total} logged successfully.`);
            })
            .catch((error) => {
                console.error("Error logging final score (Check Rules/Network):", error);
            });
        }
        
        // ==================================================================================
        // END FIREBASE SETUP
        // ==================================================================================

        let ALL_QUESTIONS = [];
        let QUIZ_DATA = {};
        const TARGET_QUESTION_COUNT = 20;
        const TABLE_NAME = 'elasticity'; 

        // ... (Your shuffleAndSlice, cleanText, renderDifficultySelection, 
        // createDifficultyCard, startQuiz, renderQuiz, and storeAnswer functions) ...
        
        // --- Core Quiz State Management ---
        
        function shuffleAndSlice(array, count) {
            const shuffled = array.sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }
        
        function cleanText(text) {
            if (!text) return '';
            
            let cleaned = text;

            // Remove common redundant prefixes
            cleaned = cleaned
                .replace(/^\s*\*\*?(Assertion \(A\)|Scenario|Case|Reason \(R\)):\*\*\s*/i, '')
                .trim(); 

            // Convert LaTeX notation
            cleaned = cleaned
                .replace(/\$\$(.*?)\$\$/g, '<span class="math-formula inline-block my-1 italic">$1</span>')
                .replace(/\\text\{([^\}]+)\}/g, '$1')
                .replace(/\\\$/g, 'â‚¹')
                .replace(/\\\\/g, '<br>')
                .replace(/\\(left|right)[\(\)\|\{\}]/g, '')
                .replace(/\$/g, '');

            // Convert all other Markdown bolding to HTML strong
            cleaned = cleaned.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            return cleaned;
        }

        function renderDifficultySelection(fullData) {
            const standardizedData = fullData.map(q => ({
                ...q,
                difficulty: q.difficulty ? q.difficulty.toLowerCase().trim() : 'medium'
            }));

            const simpleQuestions = standardizedData.filter(q => q.difficulty.includes('simple') || q.difficulty.includes('easy'));
            const mediumQuestions = standardizedData.filter(q => q.difficulty.includes('medium') || q.difficulty.includes('moderate'));
            const complexQuestions = standardizedData.filter(q => 
                q.difficulty.includes('complex') || 
                q.difficulty.includes('advanced') || 
                q.difficulty.includes('advance') ||
                q.difficulty.includes('high')
            );

            ALL_QUESTIONS = {
                simple: simpleQuestions,
                medium: mediumQuestions,
                complex: complexQuestions 
            };

            const html = `
                <h2 class="text-2xl font-extrabold text-cbse-blue mb-4">Choose Your Difficulty Level</h2> 
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-start"> 
                    ${createDifficultyCard('simple', simpleQuestions.length, 'Easy start, covers foundational concepts.', 'bg-accent-green hover:bg-green-700')}
                    ${createDifficultyCard('medium', mediumQuestions.length, 'Moderate difficulty, requires application of concepts.', 'bg-yellow-600 hover:bg-yellow-700')}
                    ${createDifficultyCard('complex', complexQuestions.length, 'High difficulty, includes numericals and critical analysis.', 'bg-red-600 hover:bg-red-700')}
                </div>
            `;
            document.getElementById('quiz-container').innerHTML = html;
        }

        function createDifficultyCard(level, count, description, colorClass) {
            const actualCount = Math.min(count, TARGET_QUESTION_COUNT);
            const buttonText = count >= TARGET_QUESTION_COUNT 
                ? `Start Quiz (${TARGET_QUESTION_COUNT} Qs)` 
                : `Start Quiz (${count} Qs)`;
            
            const displayName = level.charAt(0).toUpperCase() + level.slice(1);
            
            // FIX 2: Added h-full to make all cards the same height, preventing vertical shift
            return `
                <div class="p-4 bg-cbse-light rounded-lg shadow-md border border-gray-200 h-full"> 
                    <h4 class="text-xl font-bold capitalize text-cbse-blue mb-2">${displayName === 'Complex' ? 'Advanced' : displayName}</h4> 
                    <p class="text-gray-600 text-sm mb-3">${description}</p> 
                    <p class="text-xs font-semibold mb-3 text-gray-700">Available: ${count} questions. Starting: ${actualCount} questions.</p> 
                    <button 
                        class="w-full px-4 py-2 text-white font-bold rounded-lg shadow-md transition duration-150 ${colorClass}"
                        onclick="startQuiz('${level}')">
                        ${buttonText}
                    </button>
                </div>
            `;
        }

        function startQuiz(difficulty) {
            const allQs = ALL_QUESTIONS[difficulty];
            QUIZ_DATA.questions = shuffleAndSlice(allQs, TARGET_QUESTION_COUNT);
            QUIZ_DATA.difficulty = difficulty;
            QUIZ_DATA.answers = {}; 

            renderQuiz();
        }
        
        function renderQuiz() {
            const container = document.getElementById('quiz-container');
            
            const displayDifficulty = QUIZ_DATA.difficulty.charAt(0).toUpperCase() + QUIZ_DATA.difficulty.slice(1);
            const titleDifficulty = displayDifficulty === 'Complex' ? 'Advanced' : displayDifficulty;

            let quizHtml = `<h2 class="text-2xl font-extrabold text-cbse-blue mb-4">${titleDifficulty} Quiz (${QUIZ_DATA.questions.length} Questions)</h2>`;
            
            QUIZ_DATA.questions.forEach((q, index) => {
                const questionNumber = index + 1;
                
                const rawQuestionText = q.question_text || '';
                const typeString = q.question_type ? q.question_type.toLowerCase() : '';
                
                const isAssertionType = typeString.includes('a&r') || typeString.includes('ar') || typeString.includes('assertion');

                let questionText; 
                if (isAssertionType) {
                    const assertionPart = rawQuestionText.split(/\*\*Reason \(R\):\*\*/i)[0];
                    questionText = cleanText(assertionPart); 
                } else {
                    questionText = cleanText(rawQuestionText);
                }
                
                const hasType = isAssertionType || typeString.includes('case'); 
                const hasRawText = q.scenario_reason_text && q.scenario_reason_text.trim() !== '' && q.scenario_reason_text.toUpperCase() !== 'N/A';
                
                const showScenario = hasType && hasRawText;
                
                const scenarioReasonText = showScenario ? cleanText(q.scenario_reason_text) : ''; 
                const scenarioBoxTitle = isAssertionType ? 'Reason (R):' : 'Scenario:';

                let options = [];
                if (isAssertionType) {
                    options = [
                        { key: 'A', text: cleanText(q.option_a) },
                        { key: 'B', text: cleanText(q.option_b) },
                        { key: 'C', text: cleanText(q.option_c) },
                        { key: 'D', text: cleanText(q.option_d) }
                    ];
                } else {
                    options = [
                        { key: 'A', text: cleanText(q.option_a) },
                        { key: 'B', text: cleanText(q.option_b) },
                        { key: 'C', text: cleanText(q.option_c) },
                        { key: 'D', text: cleanText(q.option_d) }
                    ].filter(opt => opt.text !== null && opt.text.trim() !== '');
                }

                const cardMargin = index < QUIZ_DATA.questions.length - 1 ? 'mb-4' : 'mb-0'; 
                
                quizHtml += `
                    <div id="q-card-${index}" class="question-card p-4 ${cardMargin} bg-white border border-gray-200 rounded-lg shadow-sm">
                        <p class="text-base font-semibold text-gray-800 mb-2">${questionNumber}. ${questionText}</p> 
                        
                        ${showScenario && scenarioReasonText ? 
                            `<div class="p-2 mb-2"> 
                                <p class="text-sm font-normal text-gray-800">
                                    <span class="font-bold text-cbse-blue">${scenarioBoxTitle}</span> ${scenarioReasonText}
                                </p>
                            </div>` 
                            : ''}
                        
                        <div class="options space-y-1"> 
                            ${options.map(opt => `
                                <label class="block p-2 border border-gray-100 rounded-lg cursor-pointer hover:bg-cbse-light transition duration-150 text-sm"> 
                                    <input 
                                        type="radio" 
                                        name="q_${index}" 
                                        value="${opt.key}" 
                                        onchange="storeAnswer(${index}, this.value)"
                                        class="mr-3 text-cbse-blue focus:ring-cbse-blue"
                                    >
                                    <span class="font-medium">${opt.key}.</span> ${opt.text}
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            quizHtml += `
                <button 
                    id="submit-button"
                    class="w-full mt-4 px-6 py-3 text-lg bg-cbse-blue text-white font-bold rounded-lg shadow-xl hover:bg-blue-700 transition duration-150"
                    onclick="submitQuiz()">
                    Submit Answers
                </button>
                <button 
                    class="w-full mt-2 text-xs text-gray-500 hover:text-cbse-blue transition duration-150"
                    onclick="renderDifficultySelection(ALL_QUESTIONS.simple.concat(ALL_QUESTIONS.medium, ALL_QUESTIONS.complex))">
                    Go Back to Difficulty Selection
                </button>
            `;

            container.innerHTML = quizHtml;
        }
        
        function storeAnswer(qIndex, answerKey) {
            QUIZ_DATA.answers[qIndex] = answerKey;
        }

        function submitQuiz() {
            const totalQuestions = QUIZ_DATA.questions.length;
            let score = 0;
            
            QUIZ_DATA.questions.forEach((q, index) => {
                const userAnswer = QUIZ_DATA.answers[index];
                const correctAnswer = q.correct_answer_key;
                const questionCard = document.getElementById(`q-card-${index}`);
                
                const radios = questionCard.querySelectorAll(`input[name="q_${index}"]`);
                radios.forEach(radio => radio.disabled = true);

                if (userAnswer === correctAnswer) {
                    score++;
                    questionCard.classList.add('border-correct', 'bg-green-50');
                } else {
                    questionCard.classList.add('border-incorrect', 'bg-red-50');
                }

                const optionsContainer = questionCard.querySelector('.options');
                const options = optionsContainer.querySelectorAll('label');

                options.forEach(label => {
                    const input = label.querySelector('input');
                    const optionKey = input.value;
                    
                    if (optionKey === correctAnswer) {
                        label.classList.add('bg-correct', 'text-white', 'font-bold');
                        label.classList.remove('hover:bg-cbse-light');
                    } else if (optionKey === userAnswer && userAnswer !== correctAnswer) {
                        label.classList.add('bg-incorrect', 'text-white', 'font-bold');
                        label.classList.remove('hover:bg-cbse-light');
                    } else {
                        label.classList.add('opacity-50');
                    }
                });
            });

            // =========================================================================
            // FIREBASE LOGGING CALL MOVED TO THE CORRECT LOCATION (CRITICAL FIX)
            // =========================================================================
            // Variables 'score' and 'totalQuestions' are now defined!
            const chapterName = "4. Elasticity of Demand"; // Chapter name
            const difficultyLevel = QUIZ_DATA.difficulty || "Medium"; // Use dynamic difficulty
            
            // This function call sends the score to Firestore:
            logFinalQuizScore(score, totalQuestions, chapterName, difficultyLevel);
            // =========================================================================
            
            const scoreHtml = `
                <div class="p-4 md:p-6 mb-4 text-center bg-cbse-blue text-white rounded-lg shadow-2xl"> 
                    <h3 class="text-3xl font-extrabold mb-1">Quiz Complete!</h3> 
                    <p class="text-5xl font-black">${score}/${totalQuestions}</p> 
                    <p class="text-lg font-semibold mt-1">Your Score is: ${((score / totalQuestions) * 100).toFixed(1)}%</p> 
                </div>
            `;
            document.getElementById('quiz-container').insertAdjacentHTML('afterbegin', scoreHtml);
            document.getElementById('submit-button').remove(); 

            document.getElementById('quiz-container').scrollIntoView({ behavior: 'smooth' });
        } // End of submitQuiz function

        // --- Supabase Connection and Initialization ---

        function initSupabase() {
            const configError = document.getElementById('config-error');

            if (typeof window.SUPABASE_URL === 'undefined' || typeof window.SUPABASE_ANON_KEY === 'undefined') {
                configError.classList.remove('hidden');
                console.error("Configuration failed: Supabase keys are missing.");
            } else {
                const supabaseClient = supabase.createClient(
                    window.SUPABASE_URL,
                    window.SUPABASE_ANON_KEY
                );
                
                console.log("Supabase client initialized successfully. Attempting to fetch quiz data.");
                fetchQuizData(supabaseClient); 
            }
        }

        async function fetchQuizData(supabaseClient) {
            const container = document.getElementById('quiz-container');

            const { data: quizData, error } = await supabaseClient
                .from(TABLE_NAME)
                .select('*');

            if (error) {
                console.error('Supabase Query Error:', error);
                if (container) {
                    container.innerHTML = `<p class="error-message text-red-700 bg-red-100 p-4 rounded">Error retrieving questions: ${error.message}. Please check RLS policy for the table **${TABLE_NAME}**.</p>`;
                }
                return;
            }

            if (quizData && quizData.length > 0) {
                console.log(`Quiz data loaded successfully! Array(${quizData.length})`, quizData);
                renderDifficultySelection(quizData);
            } else {
                if (container) {
                    container.innerHTML = `<p class="text-gray-700 p-4 rounded">No questions found. The table **${TABLE_NAME}** is empty or the RLS policy is blocking access, but not giving a proper error code.</p>`;
                }
            }
        }

        // Start the application after the script loads
        initSupabase();
    </script>
</body>
</html>
