<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Demand Chapter Quiz â€” Economics</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load React and ReactDOM from CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Load Babel for JSX/TSX support in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Load Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- CONFIGURE TAILWIND COLORS -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'cbse-blue': '#1a3e6a', 
                        'cbse-light': '#f0f4f8', 
                        'accent-green': '#059669', 
                    }
                }
            }
        }
    </script>
    
    <!-- 1. LOAD CONFIGURATION FILE FIRST -->
    <!-- The keys from js/config.js are loaded here -->
    <script src="./js/config.js"></script> 
</head>
<body class="bg-cbse-light min-h-screen antialiased">
    
    <!-- The root element where the React App will mount -->
    <div id="quiz-root">
        <div class="flex items-center justify-center min-h-screen">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-cbse-blue"></div>
        </div>
    </div>

    <!-- 2. THE REACT/JSX CODE FOR THE QUIZ -->
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { createClient } = supabase;

        // Configuration variables are now accessed directly from the 'window' object 
        // within the component logic to avoid the "already declared" error.

        const TOTAL_QUESTIONS_TO_PULL = 20;
        const QUIZ_DURATION_MINUTES = 30;

        // Mock Data for offline testing 
        const MOCK_DEMAND_MCQ = Array.from({ length: 100 }, (_, i) => ({
            id: i + 1,
            question_text: `Which factor is most likely to cause an outward shift in the demand curve for good X? (Mock Q ${i + 1})`,
            options: [
                'A rise in the price of good X.',
                'A decrease in consumer income.',
                'An increase in the price of a substitute good.',
                'A successful advertising campaign for good X.',
            ],
            correct_answer_index: (i % 4)
        }));

        // Function to select N random questions from a list
        const selectRandomQuestions = (allQuestions, count) => {
            if (allQuestions.length === 0) return [];
            const shuffled = [...allQuestions].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        };


        // --- 2. MAIN QUIZ COMPONENT ---

        const DemandQuizApp = () => {
            const [quizQuestions, setQuizQuestions] = useState([]);
            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
            const [userAnswers, setUserAnswers] = useState([]);
            const [timerSeconds, setTimerSeconds] = useState(QUIZ_DURATION_MINUTES * 60);
            const [quizStatus, setQuizStatus] = useState('loading'); // 'loading' | 'active' | 'completed' | 'review'
            const [error, setError] = useState(null);
            
            // State for Supabase client, initialized to undefined to properly gate the fetching effect
            const [supabaseClient, setSupabaseClient] = useState(undefined);

            // --- 1. Client Initialization ---
            useEffect(() => {
                // Accessing globals directly from window
                const SUPABASE_URL = window.SUPABASE_URL;
                const SUPABASE_KEY = window.SUPABASE_KEY;
                
                const IS_CONFIG_VALID = typeof SUPABASE_URL === 'string' && 
                                        SUPABASE_URL.startsWith('http') && 
                                        SUPABASE_URL !== 'YOUR_SUPABASE_URL_HERE';

                if (IS_CONFIG_VALID) {
                    try {
                        // Attempt to create the client
                        const client = createClient(SUPABASE_URL, SUPABASE_KEY);
                        setSupabaseClient(client);
                        console.log("Supabase Client initialized successfully within component.");
                    } catch (e) {
                        console.error("Error during Supabase createClient:", e);
                        // If initialization fails, set state to null explicitly to trigger fetchQuestions fall-through
                        setSupabaseClient(null); 
                    }
                } else {
                    console.warn("Supabase configuration missing or invalid placeholder detected. Client remains null.");
                    // Explicitly set to null when config is bad
                    setSupabaseClient(null); 
                }
            }, []); // Run once on mount


            // --- 2. Data Fetching (Supabase & Fallback) ---
            useEffect(() => {
                // If supabaseClient is still 'undefined', it means useEffect 1 hasn't finished running yet. Wait for it.
                if (supabaseClient === undefined) return;
                
                const fetchQuestions = async () => {
                    setError(null);
                    setQuizStatus('loading');
                    
                    // If the client is null, it means the config was bad (from useEffect 1). Fall back immediately.
                    if (!supabaseClient) {
                        const message = "Supabase client failed to initialize or configuration invalid. Loading mock data for demonstration.";
                        setError(message);
                        console.warn(message);
                        
                        const mockSelected = selectRandomQuestions(MOCK_DEMAND_MCQ, TOTAL_QUESTIONS_TO_PULL);
                        setQuizQuestions(mockSelected);
                        setUserAnswers(mockSelected.map(q => ({ questionId: q.id, selectedOptionIndex: null })));
                        setQuizStatus('active');
                        return;
                    }

                    try {
                        // Fetch ALL questions from the 'demand_mcqs' table
                        const { data: allQuestions, error: dbError } = await supabaseClient
                            .from('demand_mcqs') 
                            .select('id, question_text, options, correct_answer_index') 
                            .limit(100); 

                        if (dbError) throw dbError;

                        const selectedQuestions = selectRandomQuestions(allQuestions, TOTAL_QUESTIONS_TO_PULL);
                        
                        if (selectedQuestions.length === 0) {
                             console.warn("Supabase returned no questions. Falling back to mock data.");
                             const mockSelected = selectRandomQuestions(MOCK_DEMAND_MCQ, TOTAL_QUESTIONS_TO_PULL);
                             setQuizQuestions(mockSelected);
                             setUserAnswers(mockSelected.map(q => ({ questionId: q.id, selectedOptionIndex: null })));
                        } else {
                            setQuizQuestions(selectedQuestions);
                            setUserAnswers(selectedQuestions.map(q => ({ questionId: q.id, selectedOptionIndex: null })));
                        }

                        setQuizStatus('active');

                    } catch (err) {
                        console.error("Error loading questions:", err.message);
                        setError("Could not load questions from database. Check console/network tab. Loading mock data.");
                        
                        const mockSelected = selectRandomQuestions(MOCK_DEMAND_MCQ, TOTAL_QUESTIONS_TO_PULL);
                        setQuizQuestions(mockSelected);
                        setUserAnswers(mockSelected.map(q => ({ questionId: q.id, selectedOptionIndex: null })));
                        setQuizStatus('active');
                    }
                };
                
                // Fetch questions once the client state is definitively set (either a client object or null)
                fetchQuestions();

            }, [supabaseClient]); // Rerun when client object is set/changes.

            // --- Timer Logic (Unchanged) ---
            useEffect(() => {
                if (quizStatus === 'active' && timerSeconds > 0) {
                    const timer = setInterval(() => {
                        setTimerSeconds(prevSeconds => prevSeconds - 1);
                    }, 1000);
                    return () => clearInterval(timer);
                } else if (quizStatus === 'active' && timerSeconds === 0) {
                    handleSubmitQuiz();
                }
            }, [quizStatus, timerSeconds]);

            // --- Handlers (Unchanged) ---

            const handleOptionSelect = (optionIndex) => {
                if (quizStatus !== 'active' || !quizQuestions.length) return;

                setUserAnswers(prevAnswers => {
                    const currentQuestionId = quizQuestions[currentQuestionIndex].id;
                    const existingAnswerIndex = prevAnswers.findIndex(a => a.questionId === currentQuestionId);

                    if (existingAnswerIndex !== -1) {
                        const newAnswers = [...prevAnswers];
                        newAnswers[existingAnswerIndex] = {
                            ...newAnswers[existingAnswerIndex],
                            selectedOptionIndex: optionIndex
                        };
                        return newAnswers;
                    }
                    return prevAnswers;
                });
            };

            const handleNavigation = (direction) => {
                if (direction === 'next' && currentQuestionIndex < quizQuestions.length - 1) {
                    setCurrentQuestionIndex(currentQuestionIndex + 1);
                } else if (direction === 'previous' && currentQuestionIndex > 0) {
                    setCurrentQuestionIndex(currentQuestionIndex - 1);
                }
            };
            
            const handleSubmitQuiz = () => {
                setQuizStatus('completed');
                setTimerSeconds(0);
            };

            // --- Computed Values (Unchanged) ---
            const formatTime = (totalSeconds) => {
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            };

            const score = useMemo(() => {
                if (quizStatus !== 'completed' && quizStatus !== 'review') return 0;
                let correctCount = 0;
                quizQuestions.forEach(q => {
                    const userAns = userAnswers.find(a => a.questionId === q.id);
                    if (userAns && userAns.selectedOptionIndex === q.correct_answer_index) {
                        correctCount++;
                    }
                });
                return correctCount;
            }, [quizStatus, quizQuestions, userAnswers]);


            // --- 3. RENDERING LOGIC (Unchanged) ---

            const renderTimer = () => (
                <div className={`text-xl font-semibold p-2 rounded-lg transition-colors ${timerSeconds <= 300 ? 'bg-red-100 text-red-600 border border-red-300' : 'bg-blue-50 text-blue-700 border border-blue-200'}`}>
                    Time Remaining: {formatTime(timerSeconds)}
                </div>
            );
            
            const renderActiveQuiz = () => {
                const q = quizQuestions[currentQuestionIndex];
                if (!q) return <div className="text-center p-8 text-gray-500">Error: Question not found.</div>;

                const currentSelected = userAnswers.find(a => a.questionId === q.id)?.selectedOptionIndex;

                return (
                    <div className="bg-white p-8 rounded-xl shadow-2xl border border-gray-100 max-w-4xl w-full mx-auto">
                        {/* Display error prominently if quiz is active but there was a config/fetch error */}
                        {error && (
                            <div className="mb-6 bg-yellow-100 p-4 rounded-lg border border-yellow-300 text-yellow-800">
                                <p className="font-semibold">Note:</p>
                                <p>{error}</p>
                            </div>
                        )}
                        
                        <h2 className="text-2xl font-extrabold text-gray-800 mb-6 border-b pb-4">
                            Question {currentQuestionIndex + 1} of {quizQuestions.length}
                        </h2>
                        
                        <p className="text-lg font-medium mb-8 text-gray-700">{q.question_text}</p>
                        
                        <div className="space-y-4">
                            {q.options.map((option, index) => {
                                const isSelected = currentSelected === index;
                                return (
                                    <button
                                        key={index}
                                        onClick={() => handleOptionSelect(index)}
                                        className={`w-full text-left p-4 rounded-lg transition-all duration-200 border-2
                                            ${isSelected 
                                                ? 'bg-cbse-blue text-white shadow-md border-cbse-blue scale-[1.01]' 
                                                : 'bg-gray-50 text-gray-800 hover:bg-blue-50 hover:border-blue-300 border-gray-200'
                                            }
                                        `}
                                    >
                                        <span className="font-bold mr-3">{String.fromCharCode(65 + index)}.</span> {option}
                                    </button>
                                );
                            })}
                        </div>

                        {/* Navigation and Submission */}
                        <div className="mt-10 flex justify-between items-center pt-6 border-t">
                            <button
                                onClick={() => handleNavigation('previous')}
                                disabled={currentQuestionIndex === 0}
                                className="px-6 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg shadow-md hover:bg-gray-300 transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                &larr; Previous
                            </button>
                            
                            {currentQuestionIndex === quizQuestions.length - 1 ? (
                                <button
                                    onClick={handleSubmitQuiz}
                                    className="px-8 py-3 bg-accent-green text-white font-bold text-lg rounded-lg shadow-xl hover:bg-green-700 transition duration-150 transform hover:scale-[1.03]"
                                >
                                    Submit Quiz
                                </button>
                            ) : (
                                <button
                                    onClick={() => handleNavigation('next')}
                                    className="px-6 py-2 bg-cbse-blue text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-150"
                                >
                                    Next &rarr;
                                </button>
                            )}
                        </div>
                    </div>
                );
            };

            const renderCompletionResults = () => (
                <div className="bg-white p-12 rounded-xl shadow-2xl border-4 border-accent-green max-w-3xl w-full mx-auto text-center">
                    {error && (
                        <div className="mb-6 bg-yellow-100 p-4 rounded-lg border border-yellow-300 text-yellow-800">
                            <p className="font-semibold">Data Warning:</p>
                            <p>{error}</p>
                        </div>
                    )}
                    <h1 className="text-4xl font-extrabold text-accent-green mb-4">Quiz Completed!</h1>
                    <p className="text-xl text-gray-600 mb-8">Your results for the Demand chapter quiz are:</p>

                    <div className="bg-green-50 p-6 rounded-lg mb-8">
                        <p className="text-5xl font-bold text-accent-green">{score} / {quizQuestions.length}</p>
                        <p className="text-xl text-green-700 mt-2">Final Score</p>
                    </div>
                    
                    <button
                        onClick={() => setQuizStatus('review')}
                        className="px-8 py-3 bg-cbse-blue text-white font-bold text-lg rounded-lg shadow-xl hover:bg-blue-700 transition duration-150 transform hover:scale-[1.03] mt-4"
                    >
                        Review All Answers
                    </button>
                </div>
            );

            const renderReviewMode = () => (
                <div className="bg-white p-8 rounded-xl shadow-2xl border border-gray-100 max-w-6xl w-full mx-auto">
                    {error && (
                        <div className="mb-6 bg-yellow-100 p-4 rounded-lg border border-yellow-300 text-yellow-800">
                            <p className="font-semibold">Data Warning:</p>
                            <p>{error}</p>
                        </div>
                    )}
                    <h1 className="text-3xl font-extrabold text-cbse-blue mb-6 border-b pb-4">
                        Quiz Review ({score}/{quizQuestions.length})
                    </h1>
                    <p className="text-red-600 font-medium mb-6">Incorrect answers are marked with a line through your selected option. Correct answers are highlighted in green.</p>
                    
                    <div className="space-y-10">
                        {quizQuestions.map((q, index) => {
                            const userAns = userAnswers.find(a => a.questionId === q.id);
                            const isCorrect = userAns?.selectedOptionIndex === q.correct_answer_index;
                            const resultStyle = isCorrect 
                                ? 'border-green-400 bg-green-50' 
                                : (userAns?.selectedOptionIndex !== null ? 'border-red-400 bg-red-50' : 'border-yellow-400 bg-yellow-50');

                            return (
                                <div key={q.id} className={`p-5 rounded-lg border-l-8 ${resultStyle} shadow-sm`}>
                                    <p className="text-lg font-semibold text-gray-800 mb-3">
                                        {index + 1}. {q.question_text}
                                    </p>
                                    
                                    <div className="space-y-2">
                                        {q.options.map((option, optIndex) => {
                                            const isUserSelection = userAns?.selectedOptionIndex === optIndex;
                                            const isCorrectAnswer = q.correct_answer_index === optIndex;
                                            
                                            let optionClass = 'p-3 rounded-md text-sm transition-all duration-150';
                                            
                                            if (isCorrectAnswer) {
                                                optionClass += ' bg-green-200 font-bold text-green-800';
                                            } else if (isUserSelection && !isCorrect) {
                                                optionClass += ' bg-red-200 line-through text-red-800'; 
                                            } else {
                                                optionClass += ' bg-white text-gray-700';
                                            }

                                            return (
                                                <div key={optIndex} className={optionClass}>
                                                    <span className="font-bold mr-2">{String.fromCharCode(65 + optIndex)}.</span> 
                                                    {option} 
                                                    {isCorrectAnswer && <span className="ml-2 text-xs font-bold text-green-900">(Correct)</span>}
                                                    {isUserSelection && !isCorrectAnswer && <span className="ml-2 text-xs font-bold text-red-900">(Your Selection)</span>}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                    <a href="economics.html"
                        className="mt-10 inline-block px-6 py-2 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600 transition duration-150"
                    >
                        &larr; Back to Economics Page
                    </a>
                </div>
            );


            let content;
            let showTimer = false;

            switch (quizStatus) {
                case 'loading':
                    content = (
                        <div className="text-center p-20">
                            <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-cbse-blue mx-auto mb-4"></div>
                            {/* Prominent error display in the loading state */}
                            {error ? (
                                <div className="mt-4 bg-red-100 p-4 rounded-lg border border-red-300">
                                    <p className="text-xl font-semibold text-red-700">Database Connection Warning:</p>
                                    <p className="text-lg text-red-600 mt-2">{error}</p>
                                </div>
                            ) : (
                                <p className="text-xl text-gray-600">Loading 20 random questions from the database...</p>
                            )}
                        </div>
                    );
                    break;
                case 'active':
                    content = renderActiveQuiz();
                    showTimer = true;
                    break;
                case 'completed':
                    content = renderCompletionResults();
                    break;
                case 'review':
                    content = renderReviewMode();
                    break;
                default:
                    content = <div className="text-center p-20 text-red-500">An unexpected error occurred.</div>;
            }

            return (
                <div className="min-h-screen bg-cbse-light p-4 sm:p-10 font-sans">
                    <header className="mb-8 flex flex-col sm:flex-row justify-between items-center max-w-6xl mx-auto">
                        <h1 className="text-3xl font-extrabold text-cbse-blue">
                            Economics: Demand Chapter Quiz
                        </h1>
                        {showTimer && renderTimer()}
                    </header>
                    
                    <main className="pb-10">
                        {content}
                    </main>

                    <footer className="text-center text-sm text-gray-500 mt-10">
                        <p>Powered by Supabase (or Mock Data). Timed for {QUIZ_DURATION_MINUTES} minutes.</p>
                    </footer>
                </div>
            );
        };
        
        // --- 4. MOUNT REACT APP ---
        const container = document.getElementById('quiz-root');
        const root = ReactDOM.createRoot(container);
        root.render(<DemandQuizApp />);
    </script>
</body>
</html>
