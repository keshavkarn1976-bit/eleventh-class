<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Economy Simulator & Payment</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://kit.fontawesome.com/a7b5e61239.js" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #1f2937; color: #f9fafb; }
        .card { background-color: #374151; border: 1px solid #4b5563; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .btn-primary { background-color: #3b82f6; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-secondary { background-color: #4b5563; color: #f9fafb; }
        .btn-secondary:hover { background-color: #6b7280; }
        .auth-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .modal { background-color: rgba(0, 0, 0, 0.7); }
        .spinner { border-top-color: #3b82f6; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="global-modal" class="modal fixed inset-0 z-50 hidden items-center justify-center p-4" onclick="hideModal()">
    <div class="card w-full max-w-md p-6 rounded-lg text-center" onclick="event.stopPropagation()">
        <h3 id="modal-title" class="text-xl font-bold mb-4 text-white"></h3>
        <p id="modal-message" class="text-gray-300 mb-6"></p>
        <button onclick="hideModal()" class="btn-primary py-2 px-4 rounded-lg font-semibold w-full">Close</button>
    </div>
</div>

<div id="app-container" class="auth-container p-4">
    
    <div id="auth-screen" class="card p-8 rounded-xl w-full max-w-md text-center">
        <h1 class="text-3xl font-bold mb-6 text-white">Welcome Back</h1>
        <p class="text-gray-400 mb-8">Sign in to start your economy simulation and secure your account.</p>
        <button id="google-signin-btn" class="btn-primary py-3 px-6 rounded-xl font-semibold w-full flex items-center justify-center space-x-3">
            <i class="fab fa-google text-lg"></i>
            <span>Sign in with Google</span>
        </button>
        <p class="mt-4 text-sm text-gray-500" id="auth-status">Awaiting authentication...</p>
    </div>

    <div id="main-app-screen" class="hidden w-full max-w-4xl space-y-8">
        <header class="flex justify-between items-center p-4 bg-gray-800 rounded-xl shadow-lg">
            <h1 class="text-2xl font-bold text-blue-400">Economy Dashboard</h1>
            <div class="flex items-center space-x-4">
                <span id="user-info" class="text-sm text-gray-400 truncate"></span>
                <button id="signout-btn" class="btn-secondary py-2 px-4 rounded-lg text-sm">Sign Out</button>
            </div>
        </header>

        <div class="card p-6 rounded-xl">
            <h2 class="text-xl font-bold mb-4 border-b border-gray-600 pb-2">Subscription & Checkout</h2>
            
            <div id="loading-indicator" class="text-center py-10 hidden">
                <div class="spinner w-8 h-8 border-4 border-gray-600 rounded-full mx-auto mb-2"></div>
                <p class="text-gray-400">Processing order via Supabase Edge Function...</p>
            </div>

            <div id="checkout-content">
                <div class="flex justify-between items-center py-3 border-b border-gray-700">
                    <div class="font-semibold text-lg text-white">Pro Simulation Access</div>
                    <div class="text-2xl font-bold text-green-400">$19.99</div>
                </div>

                <div class="mt-6">
                    <button id="checkout-btn" class="btn-primary py-3 px-6 rounded-xl font-semibold w-full text-lg">
                        Proceed to Checkout
                    </button>
                    <p class="text-sm text-center mt-3 text-gray-500">This calls the 'create-order' Supabase Edge Function.</p>
                </div>
            </div>

            <div id="purchase-success" class="text-center py-6 hidden">
                <i class="fas fa-check-circle text-green-500 text-6xl mb-4"></i>
                <h3 class="text-2xl font-bold text-white mb-2">Purchase Successful!</h3>
                <p class="text-gray-400">Your Pro Simulation Access is now active (status updated in Firestore).</p>
            </div>
        </div>

        <div class="card p-6 rounded-xl">
            <h2 class="text-xl font-bold mb-4 border-b border-gray-600 pb-2">Order History</h2>
            <div class="text-gray-400 italic">Order history will be loaded here from Supabase.</div>
        </div>

    </div>

</div>

<script type="module">
    // --- FIREBASE AND SUPABASE IMPORTS ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    // =========================================================================
    // !!! IMPORTANT: REPLACE THESE PLACEHOLDERS WITH YOUR ACTUAL SUPABASE KEYS !!!
    // =========================================================================
    const SUPABASE_URL = 'https://YOUR-SUPABASE-PROJECT-ID.supabase.co'; 
    const SUPABASE_ANON_KEY = 'YOUR-SUPABASE-ANON-PUBLIC-KEY'; 
    // =========================================================================

    // --- GLOBAL VARIABLES (Provided by Canvas Environment) ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // --- FIREBASE/SUPABASE CLIENTS ---
    let app, db, auth;
    let supabase; // Supabase Client
    let currentUserId = null;
    let authReady = false;

    // --- DOM ELEMENTS ---
    const authScreen = document.getElementById('auth-screen');
    const mainAppScreen = document.getElementById('main-app-screen');
    const googleSignInBtn = document.getElementById('google-signin-btn');
    const signOutBtn = document.getElementById('signout-btn');
    const userInfoSpan = document.getElementById('user-info');
    const checkoutBtn = document.getElementById('checkout-btn');
    const loadingIndicator = document.getElementById('loading-indicator');
    const checkoutContent = document.getElementById('checkout-content');
    const purchaseSuccessDiv = document.getElementById('purchase-success');

    // --- MODAL FUNCTIONS ---
    function showModal(title, message) {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-message').textContent = message;
        document.getElementById('global-modal').classList.remove('hidden');
        document.getElementById('global-modal').classList.add('flex');
    }

    function hideModal() {
        document.getElementById('global-modal').classList.add('hidden');
        document.getElementById('global-modal').classList.remove('flex');
    }

    // --- CORE INITIALIZATION ---
    async function initializeAppAndAuth() {
        if (!firebaseConfig) {
            console.error("Firebase config not available.");
            showModal("Error", "Firebase configuration is missing.");
            return;
        }

        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        
        // Initialize Supabase Client with your keys
        supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        try {
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }
        } catch (error) {
            console.error("Firebase Auth initialization failed:", error);
            await signInAnonymously(auth); // Fallback to anonymous
        }

        onAuthStateChanged(auth, (user) => {
            authReady = true;
            if (user) {
                currentUserId = user.uid;
                handleUserLogin(user);
            } else {
                currentUserId = null;
                handleUserLogout();
            }
        });
    }

    // --- FIRESTORE USER SYNC ---
    // This function ensures a user profile exists in Firestore and checks their current payment status.
    async function syncFirestoreProfile(user) {
        if (!db || !user.uid) return;

        const userDocRef = doc(db, 'artifacts', appId, 'users', user.uid, 'user_data', 'profile');
        
        try {
            const docSnap = await getDoc(userDocRef);
            if (!docSnap.exists()) {
                // Create profile document in Firestore (creating the 'users' collection if it's the first one)
                await setDoc(userDocRef, {
                    uid: user.uid,
                    email: user.email || 'N/A',
                    displayName: user.displayName || 'Anonymous User',
                    createdAt: new Date().toISOString(),
                    hasPaid: false, // Default state
                });
            } else {
                const profileData = docSnap.data();
                // Update UI based on pre-existing payment status in Firestore
                if (profileData.hasPaid) {
                    togglePurchaseStatus(true);
                }
            }
        } catch (error) {
            console.error("Error syncing Firestore profile:", error);
        }
    }
    
    // --- FIRESTORE PAYMENT STATUS UPDATE ---
    // Updates the hasPaid status in Firestore after a successful order creation in Supabase.
    async function updateFirestorePaymentStatus(status) {
        if (!db || !currentUserId) return;
        const userDocRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'user_data', 'profile');
        try {
            await setDoc(userDocRef, { hasPaid: status }, { merge: true });
        } catch (error) {
            console.error("Error updating Firestore payment status:", error);
        }
    }


    // --- SUPABASE EDGE FUNCTION CALL (CREATE ORDER) ---
    // This function calls your deployed 'create-order' Supabase Edge Function.
    async function createOrder() {
        if (!authReady || !currentUserId || !supabase) {
            showModal("Error", "Authentication is not ready or Supabase client is not initialized.");
            return;
        }

        // Show loading state
        checkoutContent.classList.add('hidden');
        loadingIndicator.classList.remove('hidden');

        try {
            // Get the Firebase ID token for authorization
            const token = await auth.currentUser.getIdToken();

            const orderData = {
                user_id: currentUserId,
                amount: 19.99,
                description: 'Pro Simulation Access Subscription',
                currency: 'USD',
            };

            // Invoke the Supabase Edge Function 'create-order'
            const { data, error } = await supabase.functions.invoke('create-order', {
                body: orderData,
                // Pass the Firebase ID token in the Authorization header 
                // for the Supabase function to verify the user identity.
                headers: {
                    'Authorization': `Bearer ${token}`, 
                    'Content-Type': 'application/json'
                }
            });

            if (error) {
                // If the function returns an error (e.g., failed DB insert, RLS violation)
                console.error("Supabase Function Error:", error);
                throw new Error(error.message || "Failed to create order via Supabase function.");
            }
            
            // --- SUCCESS ---
            
            // 1. Update Firestore profile to reflect payment
            await updateFirestorePaymentStatus(true);

            // 2. Update UI
            togglePurchaseStatus(true);
            showModal("Success!", "Order created successfully in Supabase and your account is upgraded.");

        } catch (error) {
            console.error("Order Creation Failed:", error);
            showModal("Payment Error", `There was an issue processing your order: ${error.message}.`);
            // Ensure UI is restored if the transaction failed
            togglePurchaseStatus(false); 
        } finally {
            // Hide loading state
            loadingIndicator.classList.add('hidden');
            if (purchaseSuccessDiv.classList.contains('hidden')) {
                 checkoutContent.classList.remove('hidden');
            }
        }
    }


    // --- UI/STATE HANDLERS ---
    function handleUserLogin(user) {
        authScreen.classList.add('hidden');
        mainAppScreen.classList.remove('hidden');
        
        const display = user.isAnonymous ? 'Anonymous' : (user.displayName || user.email || 'User');
        userInfoSpan.innerHTML = `User ID: <span class="text-white font-mono text-xs">${user.uid}</span> | Signed in as: <span class="text-blue-300">${display}</span>`;
        
        // Sync the user profile (and check paid status) with Firestore
        syncFirestoreProfile(user);
    }

    function handleUserLogout() {
        authScreen.classList.remove('hidden');
        mainAppScreen.classList.add('hidden');
        togglePurchaseStatus(false); 
        userInfoSpan.textContent = 'User Info';
    }

    function togglePurchaseStatus(paid) {
        if (paid) {
            checkoutContent.classList.add('hidden');
            purchaseSuccessDiv.classList.remove('hidden');
        } else {
            checkoutContent.classList.remove('hidden');
            purchaseSuccessDiv.classList.add('hidden');
        }
    }

    // --- EVENT LISTENERS ---
    googleSignInBtn.addEventListener('click', () => {
        const provider = new GoogleAuthProvider();
        signInWithPopup(auth, provider).catch(error => {
            console.error("Google Sign-in failed:", error);
            showModal("Sign-in Failed", `Could not complete Google Sign-in: ${error.message}`);
        });
    });

    signOutBtn.addEventListener('click', () => {
        signOut(auth).catch(error => {
            console.error("Sign-out failed:", error);
            showModal("Sign-out Failed", "Could not sign out. Please try again.");
        });
    });

    checkoutBtn.addEventListener('click', createOrder);

    // --- START APPLICATION ---
    initializeAppAndAuth();
</script>

</body>
</html>
